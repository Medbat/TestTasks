using CompanyName.Captcha.Api.Primitives;
using CompanyName.Captcha.Api.Primitives.UploadCaptcha;
using CompanyName.Captcha.Api.Runtime.Abstractions;

namespace CompanyName.Captcha.Api.Runtime.UploadCaptcha.Handlers;

public class UploadCaptchaMalwareHandler : UploadCaptchaHandlerBase
{
    private readonly IMalwareDetector _malwareDetector;
        
    public UploadCaptchaMalwareHandler(IMalwareDetector malwareDetector)
    {
        _malwareDetector = malwareDetector;
    }

    public override Task<UploadCaptchaHandlerResult> Handle(IUploadCaptchaHandlerContext context)
    {
        context.FileStream.Position = 0;
        var scanResult = _malwareDetector.ScanFileStream(context.FileStream);
        if (scanResult.ScanVerdict != MalwareScanVerdict.Clean)
        {
            return Task.FromResult(new UploadCaptchaHandlerResult
            {
                IsSuccessful = false, 
                Error = "Архив не прошёл антивирусную проверку"
            });
        }

        return _successor?.Handle(context);
    }
}